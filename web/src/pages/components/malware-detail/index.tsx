import { severityMap } from '@/utils/constant';
import { Descriptions, Tag, Tree } from 'antd';
import type { DataNode } from 'antd/es/tree';
import classNames from 'classnames';
import { useEffect, useState } from 'react';
import { useParams, useIntl } from 'umi';
import type { Version } from '../version/data';
import { selectThreatDetail } from './service';
import { CopyOutlined } from '@ant-design/icons'; 

import styles from './style.less';

const colorsMap = {
  1: '#b7c5c7',
  2: '#fd9e38',
  3: '#f56767',
  4: '#e50100',
};

const baseMessageId = 'pages.detail';

const leakageDetail = () => {
  const { vid, tid } = useParams<{ vid: string; tid: string }>();
  const [version, setVersion] = useState<Version>();  
  const [detail, setDetail] = useState<LeakageDetail>();
  const [treeData, setTreeData] = useState<
    {
      label: string;
      data: DataNode[];
    }[]
  >([]);
  const { formatMessage } = useIntl();

  // console.log(vid, tid);

  const genrateTreeData = (filepath: string[]) => {
    const pathsInfo: DataNode[] = [];
    filepath.forEach((item) => {
      const nodeArray = item.split('/');
      let children = pathsInfo;
      nodeArray.forEach((i, index) => {
        const node: DataNode = {
          title: i,
          key: i + index,
        };
        if (index === nodeArray.length - 1) {
          node.isLeaf = true;
        }

        if (children.length === 0) {
          children.push(node);
        }

        let isExist = false;
        for (const j of children) {
          if (j.title === node.title) {
            if (!j.children) {
              j.children = [];
            }

            children = j.children;
            isExist = true;
            break;
          }
        }
        if (!isExist) {
          children.push(node);
          if (!children[children.length - 1].children) {
            children[children.length - 1].children = [];
          }

          children = children[children.length - 1].children!;
        }
      });
    });
    return pathsInfo;
  };

  const initPaths = (threatDetail: MalwareDetail) => {
    if (Array.isArray(threatDetail.filepath)) {
      setTreeData([
        {
          label: '',
          data: genrateTreeData(threatDetail.filepath),
        },
      ]);
    }
    
  };

  const getThreatDetail = async () => {
    const res = await selectThreatDetail({      
      threat_id: tid,
    });
    
    // console.log(`res: ${JSON.stringify(res)}`);
    if (res?.data) {
      const threatDetail = res.data.detail;
      // console.log(threatDetail);
      setVersion(res.data.version);
      setDetail(threatDetail);
      initPaths(threatDetail);
    }
  };

  const getData = async () => {    
    await getThreatDetail();
  };

  useEffect(() => {
    getData();    
  }, []);
  
  const copyToClipboard = () => {
    const jsonStr = JSON.stringify(filteredData, null, 2); // 将筛选的数据转换为JSON字符串
    navigator.clipboard.writeText(jsonStr).catch((err) => {
      console.error('Could not copy text: ', err);
    });
  };

  return (
    <>
      <div
        style={{
          backgroundColor: '#fff',
          fontWeight: 500,
          fontSize: 16,
          color: 'rgba(0,0,0,0.85)',
          padding: '16px 24px',
          marginBottom: 16,
        }}
      >
        {version?.version_name}
        <Button icon={<CopyOutlined />} onClick={copyToClipboard} style={{ marginLeft: 8 }} />
      </div>      
      <Descriptions title={detail?.threat_id} className={styles.panel} column={2}>        
        <Descriptions.Item label={formatMessage({ id: `${baseMessageId}.threat_id` })}>
          {detail?.threat_id}
        </Descriptions.Item>

        <Descriptions.Item label={formatMessage({ id: `${baseMessageId}.severity` })}>
          {
            <Tag
              style={{ borderColor: colorsMap[detail.severity], color: colorsMap[detail.severity] }}
            >
              {severityMap[detail.severity]}
            </Tag>
          }
        </Descriptions.Item>
        
        <Descriptions.Item label={formatMessage({ id: `${baseMessageId}.category` })}>
          {detail.metadata.rule}
        </Descriptions.Item>
        

        <Descriptions.Item label={formatMessage({ id: `${baseMessageId}.text` })}>
          {detail.metadata.text}
        </Descriptions.Item>

        <Descriptions.Item label={formatMessage({ id: `${baseMessageId}.offset` })}>
          {detail.metadata.offset}
        </Descriptions.Item>

        <Descriptions.Item label={formatMessage({ id: `${baseMessageId}.desc` })}>
          {detail.metadata.desc}
        </Descriptions.Item>
      </Descriptions>

      <Descriptions.Item label={formatMessage({ id: `${baseMessageId}.checksum` })}>
        {detail.checksum}
      </Descriptions.Item>

      <Descriptions
        title={formatMessage({ id: `${baseMessageId}.paths` })}
        className={classNames(styles.panel, styles.mt12)}
        column={1}
      >
        {treeData?.map((item) => (
          <Descriptions.Item key={item.label} label={item.label}>
            {!!treeData.length && (
              <Tree.DirectoryTree treeData={item.data} defaultExpandAll selectable={false} />
            )}
          </Descriptions.Item>
        ))}
      </Descriptions>
    </>
  );
};

export default leakageDetail;
